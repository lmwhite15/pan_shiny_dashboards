---
title: "HML ID Assignment"
output:
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    css: custom.css
    social: menu
    logo: PAN_logo3.png
    favicon: PAN_logo3.png
runtime: shiny
editor_options:
  chunk_output_type: console
---

```{=html}
<style type="text/css">

  .chart-title {  /* chart_title  */
    font-size: 22px;

</style>
```

```{r production}
# Is the app ready to be published to RStudio Connect?
production <- FALSE

# 2025-10-11: Terrill is owner of app in viz.datascience.arizona.edu so need 
            # to publish through his account
```

```{r setup, include=FALSE}

# Required libraries
library(shiny) # Shiny app package
library(flexdashboard) # Shiny app package
library(DBI) # Connecting to database
library(tidyverse) # Data wrangling
library(kableExtra) # Creates nice tables
library(RCurl) # Connecting to Box Health to generate new REDCap ID

# openxlsx::read.xlsx is used in manual ID generation function

# Function that logs user input and saves it in PAN db
log_function <- function(site, participant_id, hml_id, action){
    # Send info to db id app log
    log_table <- data.frame(datetime = Sys.time(),
                            site = site,
                            participant_id = participant_id,
                            hml_id = hml_id,
                            action = action,
                            production = production)
    dbWriteTable(con, "dm_hml_id_app_log", log_table, append = TRUE)
}

```

```{r load data}

# Connect to PAN Database (RStudio Connect has a different database connection)
# And get HML ID generation data
# If not in production, will download files from local folder
if(production){
  con <- dbConnect(RPostgres::Postgres(),
                   user = Sys.getenv("user")
                   , password = Sys.getenv("password")
                   , dbname = Sys.getenv("dbname")
                   , host = Sys.getenv("nlb")
                   , port = Sys.getenv("port")
  )
  
  id_dat <- dbReadTable(con, "dm_hml_id_app_data")
  
}else{
  con <- dbConnect(RPostgres::Postgres(),
                   user = Sys.getenv("user")
                   , password = Sys.getenv("password")
                   , dbname = Sys.getenv("dbname")
                   , host = Sys.getenv("host")
                   , port = Sys.getenv("port")
                   , sslrootcert = 'global-bundle.pem'
  )
  
  id_dat <- read.csv("test_hml_id_app_data.csv")
}

# Get screened participants from MindCrowd:
screened_dat <- dbReadTable(con, "dm_screened_participants") %>%
  # Create age groups and select variables needed for app
  mutate(age_group = case_when(age %in% 50:59 ~ "50-59",
                               age %in% 60:69 ~ "60-69",
                               age %in% 70:79 ~ "70-79")) %>%
  select(participant_id = participant_id_parent, sex, race, hispanic_latino, site, age_group, memory_rank) %>%
  # Make sure there aren't any duplicate IDs between sites
  distinct(participant_id, .keep_all = TRUE) %>%
  # Create variables needed to attach these IDs to the HML ID info dataframe
  mutate(hml_id = NA, hml_id_created_date = NA, hml_id_undo = NA, .after = participant_id) %>%
  mutate(across(everything(), ~ifelse(. == "", NA, .)))

# Add screened data to saved IDs to create general dataset for use in the app:
dat <- screened_dat %>%
  # Remove any participant_ids that already have HML IDs
  filter(!participant_id %in% id_dat$participant_id) %>%
  rbind(id_dat) %>%
  # Make sure there is only one row per participant in the data
  group_by(participant_id) %>% arrange(hml_id) %>% slice(1) %>% ungroup() %>%
  distinct(participant_id, .keep_all = TRUE)

```

```{r save data}

save_data <- function(production, new_dat){
  # Display progress bar while saving in progress
  withProgress(message = "Saving... Please Wait", {
    # Save data to database ---------------
    dbWriteTable(con, "dm_hml_id_app_data", new_dat, overwrite = TRUE)
    
    # Get any HML IDs that need REDCap IDs generated
    hml_id_files <- dbReadTable(con, "redcap_id_assignment")
    
    updated_ids <- new_dat %>%
      filter(!is.na(hml_id),
             !hml_id %in% hml_id_files$hml_id)
    
    if(!production){
      # If in test mode, save new assignment to local csv
      write.csv(new_dat, "test_hml_id_app_data.csv", row.names = FALSE)
      
      # Test saving new HML ID to REDCap assignment folder:
      if(nrow(updated_ids) > 0) write.csv(updated_ids, file = "test_redcap_id_assignment.csv", row.names = FALSE)
    }
    
    if(production){
      # Write new hml ids to Box for REDCap assignment ------------
      # Define Box FTPS details
      # URL encode the path
      encoded_path <- URLencode("[UA BOX Health] MindCrowd Inbound/HML_ID_Assignment/")
      
      # Define the FTPS base URL
      ftps_base_url <- "ftps://ftp.box.com/"
      
      # Combine the base URL with the encoded path
      ftps_url <- paste0(ftps_base_url, encoded_path)
      userpwd <- Sys.getenv("FTP_PASSWORD")
      
      # Define the file path on your local system (file to save to HML ID assignment folder)
      local_file <- "hml_id_data.csv"
      output_file_path <- file.path(getwd(), local_file)
      
      # If there are new IDs then upload list to Box for REDCap ID generation
      if(nrow(updated_ids) > 0){
        write.csv(updated_ids, file = output_file_path,
                  row.names = F)
        # Upload the file
        ftpUpload(
          what = output_file_path,
          to = paste0(ftps_url, basename(output_file_path)),
          userpwd = userpwd,
          verbose = TRUE
        )
      }
    }
    
  })
  
  # Pop up status message and page reload
  shinyalert::shinyalert('Saved', callbackJS = "function() {location.reload()}")
}

```

```{r create ID server}

# Filter IDs by input site sitePick ------
id_choices <- reactive(
  filter(dat, site == input$sitePick, !is.na(participant_id))
)

# Filter data by selected ID idPick -------
picked_id_data <- reactive(
  filter(dat, participant_id == input$idPick & site == input$sitePick)
)

# Create new ID and add to dataset for confirmation -------
new_data <- reactive({
  req(input$newId)
  
  # Check if ID has already been created for participant (hml id undo)
  if(!is.na(dat$hml_id_undo[which(dat$participant_id == (input$idPick))])){
    
    undone_hml_id <- id_dat$hml_id_undo[which(id_dat$participant_id == (input$idPick))]
    
    id_dat$hml_id[which(id_dat$participant_id == (input$idPick))] <- undone_hml_id
    
    return(id_dat)
    
  }else{
    
    existing_ids <- as.numeric(str_sub(c(id_dat$hml_id, id_dat$hml_id_undo), start = 4))
    
    existing_ids <- existing_ids[which(!is.na(existing_ids))]
    
    new_id <- max(existing_ids) + 1
    
    new_hml_id <- paste0("HML", str_pad(new_id, 4, pad = 0))
    
    dat$hml_id[which(dat$participant_id == (input$idPick))] <- new_hml_id
    dat$hml_id_created_date[which(dat$participant_id == (input$idPick))] <- as.character(format(Sys.Date(), "%Y-%m-%d"))
    
    # Add to ID data
    return(rbind(id_dat, dat[which(dat$participant_id == (input$idPick)),]))
    
  }
  
})

# Save new ID data to database and Box ------------

downloadNewData <- observe({
  if(isTruthy(input$saveId)){
    
    # Write to log
    log_function(site = input$sitePick,
                 participant_id = input$idPick,
                 hml_id = new_data()$hml_id[which(new_data()$participant_id == input$idPick)],
                 action = "New ID")
    
    # Save HML ID data --------------------
    save_data(production, new_dat = new_data())
  }
})

```

```{r manual ID upload server}

# Download uploaded data for confirmation and editing  ------------
id_data <- eventReactive(input$data_up, {
  req(input$data_up)
  
  id_data <- ifelse(tools::file_ext(input$data_up$datapath) == "csv",
                    read.csv(input$data_up$datapath, header = FALSE),
                    openxlsx::read.xlsx(input$data_up$datapath, colNames = FALSE))
})

# Add new HML IDs ------------
new_id_data <- reactive({
  id_data <- data.frame(id_data())
  
  # # Detect if blank csv was uploaded and, if so, display error message 
  # if(nrow(id_data) == 0) showNotification("Blank .csv uploaded.", type = "error")
  
  # Detect variable name and remove row if present
  if(!str_detect(id_data[1,1], "\\d")) id_data <- as.data.frame(id_data[-1,])
  
  id_data <- rename(id_data, "participant_id" = 1)
  
  # Check if ID already has HML
  
  check_data <- left_join(id_data[1], dat, by = "participant_id")
  
  # Get existing HML IDs
  
  existing_ids <- as.numeric(str_sub(c(id_dat$hml_id, id_dat$hml_id_undo), start = 4))
  existing_ids <- existing_ids[which(!is.na(existing_ids))]
  
  # Assign new IDs
  
  new_ids <- check_data %>%
    # Assign any IDs that were previously undone
    mutate(hml_id = ifelse(!is.na(hml_id_undo), hml_id_undo, hml_id)) %>%
    # Assign new HML IDs
    arrange(!is.na(hml_id)) %>%
    mutate(assigned = ifelse(!is.na(hml_id), "Previously assigned HML ID", ""),
           hml_id_created_date = ifelse(is.na(hml_id),
                                        as.character(format(Sys.Date(), "%Y-%m-%d")),
                                        hml_id_created_date),
           hml_id = ifelse(is.na(hml_id),
                           paste0("HML", str_pad(max(existing_ids) + row_number(), 4, pad = 0)),
                           hml_id)) %>%
    # Add recruitment site
    mutate(site = ifelse(assigned != "Previously assigned HML ID", input$site_up, site))
  
  # Add new HML IDs to submitted data list
  new_ids

})

# Submit new data ------------

downloadManualData <- observe({
  if(isTruthy(input$saveIdData)){
    new_id_dat <- new_id_data()
    
    new_dat <- id_dat %>% 
      # Remove any participants already in the deidentified_id_data
      filter(!participant_id %in% new_id_dat$participant_id) %>%
      # Join new participants with HML IDs to deidentified_id_data
      rbind(new_id_dat %>%
              select(-assigned) %>%
              mutate(hml_id_undo = NA))
    
    # Write to log
    log_function(site = input$site_up,
                 participant_id = new_id_dat$participant_id, 
                 hml_id = new_id_dat$hml_id,
                 action = "Manual ID")
    
    # Save data
    save_data(production, new_dat)
  }
})

```

```{r undo ID server}

# Filter IDs by input site sitePick and display assigned IDs -------
id_choices_undo <- reactive(
  filter(id_dat, site == input$sitePick) %>% arrange(desc(hml_id))
)

# Add undone ID and save to Drive -----------
downloadNewDataUndo <- observe({
  if(isTruthy(input$saveIdUndo)){
    new_dat <- id_dat
    
    # Write to log
    log_function(site = input$sitePick,
                 participant_id = new_dat$participant_id[which(new_dat$hml_id == input$idPickUndo)], 
                 hml_id = new_dat$hml_id[which(new_dat$hml_id == input$idPickUndo)],
                 action = "Undo ID")
    
    # Undo HML ID assignment
    new_dat$hml_id_undo[which(new_dat$hml_id == input$idPickUndo)] <- input$idPickUndo
    new_dat$hml_id[which(new_dat$hml_id == input$idPickUndo)] <- NA
    
    save_data(production, new_dat)
    
  }
})

```

<br>

{.sidebar}
===================

<br>

```{r select site}

# Select recruitment site
radioButtons("sitePick", label = "Please select the participant's recruitment site.",
            choices = c("Atlanta", "Baltimore", "Miami", "Tucson"))

```

# Generate New HML ID

## Row

#### 

<center>

```{r display id dropdown}

# Display IDs from selected site (sitePick)
renderUI(
  selectizeInput("idPick", label = "Select the participant's MindCrowd ID.",
              choices = c("",id_choices()$participant_id), selected = NULL)
)

```

```{r display participant info}

# Display selected participant's (idPick) demographics
renderUI(
  HTML(
    if(isTruthy(input$idPick)){
      kable(picked_id_data() %>% select(participant_id, site, age_group, sex),
            col.names = c("Mindcrowd Participant Parent ID", "Site", "Age Group", "Sex"),
            align = "c") %>%
        kable_styling(full_width = FALSE)
    }
  )
)

```

</center>

```{r check if participant has id}

# Gives feedback for whether participant already has an HML ID saved
renderText(
  HTML(
    if(isTruthy(input$idPick)){
      if(!is.na((picked_id_data()$hml_id))){ 
        # If participant already has an HMl ID
        paste0("This participant was assigned HML ID ", picked_id_data()$hml_id," on ", as.Date(picked_id_data()$hml_id_created_date) %>% format("%b %d, %Y"), ".")
      }else{ 
        # If person doesn't have an ID yet
        "This participant does not have an HML ID yet."
      }
    }
  )
)

```

```{r eligibility confirmation}

# Get user input for whether participant is eligible for study (eligiblePick) and doesn't have an HML ID
renderUI(
  # Display if user selects an ID
  if(isTruthy(input$idPick)){ 
    # If participant does not have an HML ID
    if(is.na((picked_id_data()$hml_id))){
      radioButtons("eligiblePick", label = "Is this person eligible for the study?",
                   choices = c("Yes", "No"), selected = "No")
    }
  }
)

```

```{r creating HML ID new}

# Display button if participant is eligible for study
renderUI(
    if(isTruthy(input$idPick) & isTruthy(input$eligiblePick)){
      if(input$eligiblePick == "Yes" & is.na((picked_id_data()$hml_id))){
        actionButton("newId", "Create New HML ID", icon = icon("plus"))
      }
    }
)

# Show data with new HML ID for confirmation
renderUI({
  # If there is an eligiblePick object created
  if(isTruthy(input$idPick) & isTruthy(input$eligiblePick)){ 
    # Only show info if person does not already have an HML ID
    if(input$eligiblePick == "Yes" & is.na((picked_id_data()$hml_id))){
      HTML(
        new_data()[which(new_data()$participant_id == input$idPick),] %>%
        remove_rownames() %>%
        select(c(participant_id, site, age_group, sex, hml_id, hml_id_created_date)) %>%
          kable(col.names = c("Mindcrowd Participant Parent ID", "Site", "Age Group", "Sex",
                              "HML ID", "HML ID Created Date"),
                align = "c") %>%
          kable_styling(full_width = FALSE)
      )
    }
  }
})

```

```{r save new id}

renderUI(
  if(isTruthy(input$idPick) & isTruthy(input$newId)){
    if(is.na((picked_id_data()$hml_id))){
      actionButton("saveId", "Save New HML ID", icon = icon("download"))
    }
  }
)

```

---

# Manual ID Upload

## Row

Manual ID Upload:

If you cannot find the participant ID in the dropdown menu, or the participant is outside of the recruitment site, please select a recruitment site and upload a csv file with the participants' participant_id_parent, participant_id, or P2 MCID.

If the submitted participant already has an HML ID, their ID and the date their ID was assigned will be displayed along with the newly created IDs for new participants.

<center>

```{r site select}

renderUI({
  selectInput("site_up", label = "Select recruitment site.",
              choices = c("", "Atlanta", "Baltimore", "Miami", "Tucson"), selected = NULL)
})

```

```{r data upload}

fileInput("data_up", 
          label = "Upload list of IDs.",
          accept = c(".csv", ".xlsx")
)

```

```{r display list}

# Display ID dataset
renderUI(
  HTML(
    if(isTruthy(input$site_up) & isTruthy(input$data_up)){
      new_id_data() %>% 
        select(participant_id, site, age_group, sex, hml_id, hml_id_created_date, assigned) %>%
        kable(align = "c",
              col.names = c("Submitted ID", "Site", "Age Group", "Sex", "HML ID", "HML ID Created Date", " ")) %>% 
        kable_styling(full_width = FALSE)
    }
  )
)

```

```{r submit data}

renderUI(
    if(isTruthy(input$site_up) & isTruthy(input$data_up)){
        actionButton("saveIdData", "Confirm and Submit", icon = icon("download"))
    }
)

```

</center>

---

# Undo HML ID

## Row

Undo HML ID Assignment:

If you assigned a new HML ID by mistake, please select the participant's HML ID from the dropdown menu and press the "Undo New HML ID" button below.

<center>

```{r undo hml dropdown}

# Display IDs from selected site (sitePick) and has an assigned ID
renderUI({
  selectInput("idPickUndo", label = "Select the participant's HML ID.",
              choices = c("",id_choices_undo()$hml_id), selected = NULL)
})

```

</center>

```{r undo hml button}

renderUI(
    if(isTruthy(input$idPickUndo)){
        actionButton("saveIdUndo", "Undo New HML ID", icon = icon("delete-left"))
    }
)

```

---

# Help

## Row

```{r}
# 08-Feb-24: Added Help tab
tags$iframe(style = "height:850px; width:100%; scrolling=yes",
            src = "HML ID generation application_Help Document Version2_2023-08-23.pdf")

```

